on:
  pull_request:
  workflow_dispatch:

jobs:
  check-py-files:
    runs-on: windows-latest
    outputs:
      has_py: ${{ steps.check.outputs.has_py }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          persist-credentials: true
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Fetch base branch
        run: git fetch origin $env:GITHUB_BASE_REF
        shell: pwsh

      - name: Check if has .py files changed
        id: check
        shell: pwsh
        run: |
          # Determine base branch: use GITHUB_BASE_REF if set, else try origin/HEAD, else fallback to 'main'
          $base = $env:GITHUB_BASE_REF
          if (-not $base -or $base -eq '') {
            $sym = git rev-parse --abbrev-ref origin/HEAD 2>$null
            if ($LASTEXITCODE -eq 0 -and $sym) { $base = $sym -replace '^origin/','' } else { $base = 'main' }
          }
          $head = $env:GITHUB_SHA

          Write-Output "Detected base branch: $base"

          # Ensure the base ref is available locally
          git fetch origin $base --no-tags --prune

          # Find changed files between base and the head commit
          $files = git diff --name-only origin/$base...$head
          $py = $files | Where-Object { $_ -like '*.py' }

          if ($py) {
            echo "has_py=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            echo "has_py=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
          exit 0

  check-py-type:
    runs-on: windows-latest
    if: |
      github.event_name != 'pull_request' || needs.check-py-files.outputs.has_py == 'true'
    needs: [check-py-files]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          persist-credentials: true
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Read .python-version
        id: pyver
        shell: pwsh
        run: |
          if (Test-Path '.python-version') {
            $v = Get-Content .python-version -Raw
            $v = $v.Trim()
            if ($v) { echo "python=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Append }
            else { echo "python=3.11" | Out-File -FilePath $env:GITHUB_OUTPUT -Append }
          } else {
            echo "python=3.11" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Set up Python from .python-version
        uses: actions/setup-python@v4
        with:
          python-version: ${{ steps.pyver.outputs.python }}

      - name: Install uv task runner and build tools
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel
          pip install uv

      - name: Run uv sync (ensure python + install project deps)
        shell: pwsh
        run: |
          uv sync --python 3.11

      - name: check type
        shell: pwsh
        run: |
          uv run tpc
